import { useCallback, useMemo, useState, type ReactNode } from 'react';

import { LanguageContext, type LanguageContextValue, type Locale } from '@/features/i18n/context';

const STORAGE_KEY = 'ws-lang';

const translations: Record<Locale, Record<string, string>> = {
  IT: {
    'login.title': 'Accedi',
    'login.subtitle': 'Login Google ufficiale o accesso ospite.',
    'login.email': 'Email',
    'login.password': 'Password',
    'login.signin': 'Accedi con email',
    'login.signup': 'Crea account',
    'login.switchToLogin': 'Hai già un account? Accedi',
    'login.switchToSignup': 'Non hai un account? Registrati',
    'login.google': 'Continua con Google',
    'login.guest': 'Entra come ospite',
    'splash.loading': 'Carico Loom…',
    'home.addItem': 'Aggiungi un capo',
    'home.emptyHint': 'Aggiungi i capi che possiedi. Loom ti aiuta a ricordarli.',
    'home.search': 'Cerca capi, tag, colori',
    'home.filter.category': 'Capo',
    'home.filter.color': 'Colore',
    'home.filter.season': 'Stagione',
    'home.new.title': 'Nuovo capo',
    'home.new.subtitle': 'Carica la foto (drag & drop o upload), poi completa i dettagli.',
    'home.new.cancel': 'Annulla',
    'home.new.save': 'Salva capo',
    'home.upload.drag': 'Trascina qui la foto del capo',
    'home.upload.click': 'Oppure clicca per scegliere un file',
    'home.upload.removeBg': 'Rimuovi sfondo (beta)',
    'home.fields.category': 'Categoria',
    'home.fields.color': 'Colore',
    'home.fields.season': 'Stagione (Primavera/Estate/Autunno/Inverno)',
    'home.fields.note': 'Note',
    'home.tags.label': 'Tag (facoltativi)',
    'home.tags.add': 'Aggiungi tag',
    'home.showMore': 'Mostra altri {count}',
    'dialog.delete.title': 'Eliminare il capo?',
    'dialog.delete.desc': 'Questa operazione rimuove la card dal tuo guardaroba.',
    'dialog.delete.noAsk': 'Non chiedere più',
    'profile.title': 'Profilo',
    'profile.account': 'Account',
    'profile.stat.total': 'Capi totali',
    'profile.stat.cat': 'Categoria più frequente',
    'profile.stat.tag': 'Tag più usato',
    'profile.stat.season': 'Stagione top',
    'profile.stat.redundancy': 'Colore prevalente: {count} capi {color} ({percent}%).',
    'profile.stat.empty': 'Non disponibile',
    'profile.logout': 'Logout',
    'profile.gender.label': 'Sesso',
    'profile.gender.female': 'Donna',
    'profile.gender.male': 'Uomo',
    'profile.avatarAlt': 'Avatar profilo',
    'profile.avatar.change': 'Cambia foto profilo',
    'drawer.categories': 'Categorie personalizzate',
    'drawer.profile': 'Profilo',
    'drawer.addCategory': 'Aggiungi categoria',
    'drawer.newCategory': 'Nuova categoria (es. Maglietta)',
    'drawer.prefs': 'Preferenze card',
    'drawer.askDelete': 'Chiedi conferma eliminazione',
    'drawer.hoverInfo': 'Mostra dettagli al passaggio',
    'toast.itemRemoved': 'Capo rimosso',
    'toast.categoryRemoved': 'Categoria rimossa',
    'toast.undo': 'Annulla',
    'support.title': 'Sostieni Loom',
    'support.body.line1': 'Loom cresce piano: completi, suggerimenti e versione telefono arriveranno con il tempo.',
    'support.body.line2': 'Se ti è utile, puoi offrirmi un caffè per sostenere lo sviluppo.',
    'support.cta': 'Offrimi un caffè ☕',
    'support.external': 'Apri un link esterno',
    'support.missing': 'Link non configurato',
    'support.what': 'Cosa finanzia?',
    'support.modal.title': 'Cosa finanzia?',
    'support.modal.bullet1': 'Completi / outfit (salvataggio e ricerca)',
    'support.modal.bullet2': 'Suggerimenti intelligenti (non invadenti)',
    'support.modal.bullet3': 'Versione mobile (UI e performance)',
    'common.close': 'Chiudi',
    'sample.item.name': 'Intimo',
    'sample.item.category': 'Intimo',
    'sample.item.color': 'Indefinito',
    'sample.item.note': 'Esempio di capo con tag e note.',
    'sample.tag.casual': 'Casual',
    'sample.tag.office': 'Ufficio',
    'nav.home': 'Home',

    'common.or': 'oppure',
    'common.all': 'Tutti',
    'common.add': 'Aggiungi',
    'common.remove': 'Rimuovi',

    'garment.noNote': 'Nessuna nota',
    'garment.menu': 'Menu',
    'garment.remove': 'Rimuovi',
    'garment.edit': 'Modifica',
    'garment.replacePhoto': 'Sostituisci foto',
    'garment.tags': 'Tag',

    'term.season.spring': 'Primavera',
    'term.season.summer': 'Estate',
    'term.season.autumn': 'Autunno',
    'term.season.winter': 'Inverno',

    'term.category.tshirt': 'Maglietta',
    'term.category.shirt': 'Camicia',
    'term.category.pants': 'Pantaloni',
    'term.category.shoes': 'Scarpe',
    'term.category.jacket': 'Giacca',
    'term.category.coat': 'Cappotto',
    'term.category.hoodie': 'Felpa',
    'term.category.dress': 'Vestito',
    'term.category.skirt': 'Gonna',
    'term.category.accessories': 'Accessori',

    'term.color.black': 'Nero',
    'term.color.white': 'Bianco',
    'term.color.gray': 'Grigio',
    'term.color.blue': 'Blu',
    'term.color.red': 'Rosso',
    'term.color.green': 'Verde',
    'term.color.yellow': 'Giallo',
    'term.color.pink': 'Rosa',
    'term.color.purple': 'Viola',
    'term.color.brown': 'Marrone',
    'term.color.beige': 'Beige',
    'term.color.orange': 'Arancione',
  },
  EN: {
    'login.title': 'Sign in',
    'login.subtitle': 'Google sign-in or guest access.',
    'login.email': 'Email',
    'login.password': 'Password',
    'login.signin': 'Sign in with email',
    'login.signup': 'Create account',
    'login.switchToLogin': 'Already have an account? Sign in',
    'login.switchToSignup': "Don't have an account? Sign up",
    'login.google': 'Continue with Google',
    'login.guest': 'Enter as guest',
    'splash.loading': 'Loading Loom…',
    'home.addItem': 'Add a garment',
    'home.emptyHint': 'Add the pieces you own. Loom helps you remember them.',
    'home.search': 'Search items, tags, colors',
    'home.filter.category': 'Item',
    'home.filter.color': 'Color',
    'home.filter.season': 'Season',
    'home.new.title': 'New garment',
    'home.new.subtitle': 'Upload a photo, then complete the details.',
    'home.new.cancel': 'Cancel',
    'home.new.save': 'Save garment',
    'home.upload.drag': 'Drag your garment photo here',
    'home.upload.click': 'Or click to choose a file',
    'home.upload.removeBg': 'Remove background (beta)',
    'home.fields.category': 'Category',
    'home.fields.color': 'Color',
    'home.fields.season': 'Season (Spring/Summer/Fall/Winter)',
    'home.fields.note': 'Notes',
    'home.tags.label': 'Tags (optional)',
    'home.tags.add': 'Add tag',
    'home.showMore': 'Show {count} more',
    'dialog.delete.title': 'Remove this garment?',
    'dialog.delete.desc': 'This will remove the card from your wardrobe.',
    'dialog.delete.noAsk': "Don't ask again",
    'profile.title': 'Profile',
    'profile.account': 'Account',
    'profile.stat.total': 'Total garments',
    'profile.stat.cat': 'Most frequent category',
    'profile.stat.tag': 'Most used tag',
    'profile.stat.season': 'Top season',
    'profile.stat.redundancy': 'Prevailing color: {count} {color} items ({percent}%).',
    'profile.stat.empty': 'Not available',
    'profile.logout': 'Sign out',
    'profile.gender.label': 'Gender',
    'profile.gender.female': 'Female',
    'profile.gender.male': 'Male',
    'profile.avatarAlt': 'Profile avatar',
    'profile.avatar.change': 'Change profile photo',
    'drawer.categories': 'Custom categories',
    'drawer.profile': 'Profile',
    'drawer.addCategory': 'Add category',
    'drawer.newCategory': 'New category (e.g. T-shirt)',
    'drawer.prefs': 'Card preferences',
    'drawer.askDelete': 'Ask delete confirmation',
    'drawer.hoverInfo': 'Show details on hover',
    'toast.itemRemoved': 'Item removed',
    'toast.categoryRemoved': 'Category removed',
    'toast.undo': 'Undo',
    'support.title': 'Support Loom',
    'support.body.line1': 'Loom grows slowly: outfits, suggestions and mobile are coming over time.',
    'support.body.line2': 'If it helps you, you can buy me a coffee to support development.',
    'support.cta': 'Buy me a coffee ☕',
    'support.external': 'Open an external link',
    'support.missing': 'Link not configured',
    'support.what': 'What does it fund?',
    'support.modal.title': 'What does it fund?',
    'support.modal.bullet1': 'Outfits (save & search)',
    'support.modal.bullet2': 'Smart suggestions (non-intrusive)',
    'support.modal.bullet3': 'Mobile version (UI and performance)',
    'common.close': 'Close',
    'sample.item.name': 'Underwear',
    'sample.item.category': 'Underwear',
    'sample.item.color': 'Undefined',
    'sample.item.note': 'Sample garment with tags and notes.',
    'sample.tag.casual': 'Casual',
    'sample.tag.office': 'Office',
    'nav.home': 'Home',

    'common.or': 'or',
    'common.all': 'All',
    'common.add': 'Add',
    'common.remove': 'Remove',

    'garment.noNote': 'No notes',
    'garment.menu': 'Menu',
    'garment.remove': 'Remove',
    'garment.edit': 'Edit',
    'garment.replacePhoto': 'Replace photo',
    'garment.tags': 'Tags',

    'term.season.spring': 'Spring',
    'term.season.summer': 'Summer',
    'term.season.autumn': 'Autumn',
    'term.season.winter': 'Winter',

    'term.category.tshirt': 'T-shirt',
    'term.category.shirt': 'Shirt',
    'term.category.pants': 'Pants',
    'term.category.shoes': 'Shoes',
    'term.category.jacket': 'Jacket',
    'term.category.coat': 'Coat',
    'term.category.hoodie': 'Hoodie',
    'term.category.dress': 'Dress',
    'term.category.skirt': 'Skirt',
    'term.category.accessories': 'Accessories',

    'term.color.black': 'Black',
    'term.color.white': 'White',
    'term.color.gray': 'Gray',
    'term.color.blue': 'Blue',
    'term.color.red': 'Red',
    'term.color.green': 'Green',
    'term.color.yellow': 'Yellow',
    'term.color.pink': 'Pink',
    'term.color.purple': 'Purple',
    'term.color.brown': 'Brown',
    'term.color.beige': 'Beige',
    'term.color.orange': 'Orange',
  },
  JA: {
    'login.title': 'ログイン',
    'login.subtitle': 'Google でログイン、またはゲストとして入る。',
    'login.email': 'メール',
    'login.password': 'パスワード',
    'login.signin': 'メールでログイン',
    'login.signup': 'アカウント作成',
    'login.switchToLogin': 'アカウントがありますか？ ログイン',
    'login.switchToSignup': 'アカウントがありませんか？ 作成',
    'login.google': 'Google で続行',
    'login.guest': 'ゲストで入る',
    'splash.loading': 'Loom を読み込み中…',
    'home.addItem': 'アイテムを追加',
    'home.emptyHint': '持っている服を追加しましょう。Loom が覚えておきます。',
    'home.search': 'アイテム・タグ・カラーを検索',
    'home.filter.category': 'アイテム',
    'home.filter.color': 'カラー',
    'home.filter.season': 'シーズン',
    'home.new.title': '新しいアイテム',
    'home.new.subtitle': '写真をアップロードして詳細を入力してください。',
    'home.new.cancel': 'キャンセル',
    'home.new.save': '保存',
    'home.upload.drag': 'ここに写真をドラッグ',
    'home.upload.click': 'またはクリックしてファイルを選択',
    'home.upload.removeBg': '背景を削除（ベータ）',
    'home.fields.category': 'カテゴリ',
    'home.fields.color': '色',
    'home.fields.season': 'シーズン（春/夏/秋/冬）',
    'home.fields.note': 'ノート',
    'home.tags.label': 'タグ（任意）',
    'home.tags.add': 'タグを追加',
    'home.showMore': 'さらに{count}件表示',
    'dialog.delete.title': 'アイテムを削除しますか？',
    'dialog.delete.desc': 'ワードローブからこのカードを削除します。',
    'dialog.delete.noAsk': '今後確認しない',
    'profile.title': 'プロフィール',
    'profile.account': 'アカウント',
    'profile.stat.total': 'アイテム総数',
    'profile.stat.cat': '最頻カテゴリ',
    'profile.stat.tag': '最頻タグ',
    'profile.stat.season': '最多シーズン',
    'profile.stat.redundancy': '優勢カラー: {color} が {count} 点（{percent}%）',
    'profile.stat.empty': 'データなし',
    'profile.logout': 'ログアウト',
    'profile.gender.label': '性別',
    'profile.gender.female': '女性',
    'profile.gender.male': '男性',
    'profile.avatarAlt': 'プロフィール画像',
    'profile.avatar.change': 'プロフィール画像を変更',
    'drawer.categories': 'カスタムカテゴリ',
    'drawer.profile': 'プロフィール',
    'drawer.addCategory': 'カテゴリを追加',
    'drawer.newCategory': '新しいカテゴリ (例: Tシャツ)',
    'drawer.prefs': 'カード設定',
    'drawer.askDelete': '削除前に確認',
    'drawer.hoverInfo': 'ホバーで詳細表示',
    'toast.itemRemoved': 'アイテムを削除しました',
    'toast.categoryRemoved': 'カテゴリを削除しました',
    'toast.undo': '元に戻す',
    'support.title': 'Loom を支援',
    'support.body.line1': 'Loom はゆっくり成長します。コーデ、提案、モバイル版は時間をかけて。',
    'support.body.line2': '役に立つなら、開発支援としてコーヒーをどうぞ。',
    'support.cta': 'コーヒーをおごる ☕',
    'support.external': '外部リンクを開く',
    'support.missing': 'リンク未設定',
    'support.what': '何に使われますか？',
    'support.modal.title': '何に使われますか？',
    'support.modal.bullet1': 'コーデ機能（保存と検索）',
    'support.modal.bullet2': 'スマート提案（控えめ）',
    'support.modal.bullet3': 'モバイル版（UI とパフォーマンス）',
    'common.close': '閉じる',
    'sample.item.name': '下着',
    'sample.item.category': '下着',
    'sample.item.color': '未設定',
    'sample.item.note': 'タグとメモ付きのサンプル。',
    'sample.tag.casual': 'カジュアル',
    'sample.tag.office': 'オフィス',
    'nav.home': 'ホーム',

    'common.or': 'または',
    'common.all': 'すべて',
    'common.add': '追加',
    'common.remove': '削除',

    'garment.noNote': 'メモなし',
    'garment.menu': 'メニュー',
    'garment.remove': '削除',
    'garment.edit': '編集',
    'garment.replacePhoto': '写真を変更',
    'garment.tags': 'タグ',

    'term.season.spring': '春',
    'term.season.summer': '夏',
    'term.season.autumn': '秋',
    'term.season.winter': '冬',

    'term.category.tshirt': 'Tシャツ',
    'term.category.shirt': 'シャツ',
    'term.category.pants': 'パンツ',
    'term.category.shoes': '靴',
    'term.category.jacket': 'ジャケット',
    'term.category.coat': 'コート',
    'term.category.hoodie': 'パーカー',
    'term.category.dress': 'ワンピース',
    'term.category.skirt': 'スカート',
    'term.category.accessories': 'アクセサリー',

    'term.color.black': '黒',
    'term.color.white': '白',
    'term.color.gray': '灰色',
    'term.color.blue': '青',
    'term.color.red': '赤',
    'term.color.green': '緑',
    'term.color.yellow': '黄',
    'term.color.pink': 'ピンク',
    'term.color.purple': '紫',
    'term.color.brown': '茶色',
    'term.color.beige': 'ベージュ',
    'term.color.orange': 'オレンジ',
  },
  RU: {
    'login.title': 'Вход',
    'login.subtitle': 'Вход через Google или как гость.',
    'login.email': 'Email',
    'login.password': 'Пароль',
    'login.signin': 'Войти по email',
    'login.signup': 'Создать аккаунт',
    'login.switchToLogin': 'Уже есть аккаунт? Войти',
    'login.switchToSignup': 'Нет аккаунта? Зарегистрироваться',
    'login.google': 'Продолжить с Google',
    'login.guest': 'Войти как гость',
    'splash.loading': 'Загружаю Loom…',
    'home.addItem': 'Добавить вещь',
    'home.emptyHint': 'Добавьте свои вещи. Loom поможет помнить о них.',
    'home.search': 'Искать вещи, теги, цвета',
    'home.filter.category': 'Вещь',
    'home.filter.color': 'Цвет',
    'home.filter.season': 'Сезон',
    'home.new.title': 'Новая вещь',
    'home.new.subtitle': 'Загрузите фото, затем заполните детали.',
    'home.new.cancel': 'Отмена',
    'home.new.save': 'Сохранить',
    'home.upload.drag': 'Перетащите фото вещи сюда',
    'home.upload.click': 'Или нажмите, чтобы выбрать файл',
    'home.upload.removeBg': 'Удалить фон (бета)',
    'home.fields.category': 'Категория',
    'home.fields.color': 'Цвет',
    'home.fields.season': 'Сезон (весна/лето/осень/зима)',
    'home.fields.note': 'Заметки',
    'home.tags.label': 'Теги (необязательно)',
    'home.tags.add': 'Добавить тег',
    'home.showMore': 'Показать ещё {count}',
    'dialog.delete.title': 'Удалить эту вещь?',
    'dialog.delete.desc': 'Это уберёт карточку из гардероба.',
    'dialog.delete.noAsk': 'Больше не спрашивать',
    'profile.title': 'Профиль',
    'profile.account': 'Аккаунт',
    'profile.stat.total': 'Всего вещей',
    'profile.stat.cat': 'Частая категория',
    'profile.stat.tag': 'Частый тег',
    'profile.stat.season': 'Главный сезон',
    'profile.stat.redundancy': 'Преобладающий цвет: {color} — {count} шт. ({percent}%).',
    'profile.stat.empty': 'Нет данных',
    'profile.logout': 'Выйти',
    'profile.gender.label': 'Пол',
    'profile.gender.female': 'Женский',
    'profile.gender.male': 'Мужской',
    'profile.avatarAlt': 'Аватар профиля',
    'profile.avatar.change': 'Сменить фото профиля',
    'drawer.categories': 'Свои категории',
    'drawer.profile': 'Профиль',
    'drawer.addCategory': 'Добавить категорию',
    'drawer.newCategory': 'Новая категория (например, футболка)',
    'drawer.prefs': 'Настройки карточек',
    'drawer.askDelete': 'Спрашивать перед удалением',
    'drawer.hoverInfo': 'Показывать детали при наведении',
    'toast.itemRemoved': 'Вещь удалена',
    'toast.categoryRemoved': 'Категория удалена',
    'toast.undo': 'Отменить',
    'support.title': 'Поддержать Loom',
    'support.body.line1': 'Loom растёт постепенно: образы, подсказки и мобильная версия появятся со временем.',
    'support.body.line2': 'Если полезно, можете угостить кофе в поддержку разработки.',
    'support.cta': 'Угостить кофе ☕',
    'support.external': 'Открыть внешнюю ссылку',
    'support.missing': 'Ссылка не настроена',
    'support.what': 'Что финансируется?',
    'support.modal.title': 'Что финансируется?',
    'support.modal.bullet1': 'Образы (сохранение и поиск)',
    'support.modal.bullet2': 'Умные подсказки (ненавязчиво)',
    'support.modal.bullet3': 'Мобильная версия (UI и производительность)',
    'common.close': 'Закрыть',
    'sample.item.name': 'Нижнее бельё',
    'sample.item.category': 'Нижнее бельё',
    'sample.item.color': 'Не задан',
    'sample.item.note': 'Пример вещи с тегами и заметками.',
    'sample.tag.casual': 'Повседневное',
    'sample.tag.office': 'Офис',
    'nav.home': 'Главная',

    'common.or': 'или',
    'common.all': 'Все',
    'common.add': 'Добавить',
    'common.remove': 'Удалить',

    'garment.noNote': 'Нет заметок',
    'garment.menu': 'Меню',
    'garment.remove': 'Удалить',
    'garment.edit': 'Изменить',
    'garment.replacePhoto': 'Заменить фото',
    'garment.tags': 'Теги',

    'term.season.spring': 'Весна',
    'term.season.summer': 'Лето',
    'term.season.autumn': 'Осень',
    'term.season.winter': 'Зима',

    'term.category.tshirt': 'Футболка',
    'term.category.shirt': 'Рубашка',
    'term.category.pants': 'Брюки',
    'term.category.shoes': 'Обувь',
    'term.category.jacket': 'Куртка',
    'term.category.coat': 'Пальто',
    'term.category.hoodie': 'Худи',
    'term.category.dress': 'Платье',
    'term.category.skirt': 'Юбка',
    'term.category.accessories': 'Аксессуары',

    'term.color.black': 'Чёрный',
    'term.color.white': 'Белый',
    'term.color.gray': 'Серый',
    'term.color.blue': 'Синий',
    'term.color.red': 'Красный',
    'term.color.green': 'Зелёный',
    'term.color.yellow': 'Жёлтый',
    'term.color.pink': 'Розовый',
    'term.color.purple': 'Фиолетовый',
    'term.color.brown': 'Коричневый',
    'term.color.beige': 'Бежевый',
    'term.color.orange': 'Оранжевый',
  },
};

export const LanguageProvider = ({ children }: { children: ReactNode }) => {
  const [locale, setLocaleState] = useState<Locale>(() => {
    if (typeof window === 'undefined') return 'IT';
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved === 'EN' || saved === 'JA' || saved === 'RU' || saved === 'IT' ? saved : 'IT';
  });

  const setLocale = useCallback((value: Locale) => {
    setLocaleState(value);
    if (typeof window !== 'undefined') {
      localStorage.setItem(STORAGE_KEY, value);
      window.dispatchEvent(new CustomEvent('ws-lang-updated', { detail: { locale: value } }));
    }
  }, []);

  const t = useCallback(
    (key: string, fallback?: string, vars?: Record<string, string | number>) => {
      const template = translations[locale]?.[key] ?? translations.IT[key] ?? fallback ?? key;
      if (!vars) return template;
      return Object.keys(vars).reduce((acc, k) => acc.replace(`{${k}}`, String(vars[k])), template);
    },
    [locale]
  );

  const value = useMemo<LanguageContextValue>(() => ({ locale, setLocale, t }), [locale, setLocale, t]);

  return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>;
};


