import{h as f,u as U,j as N,k as m,q as b,l as A,w as k,m as u,n as E,p as R}from"./firebase-DCzW8K6T.js";import{j as y}from"./index-rAj8BXmP.js";import"./vendor-77yDWcJJ.js";import"./router-YYQTkf18.js";const I=new Map,g=t=>{let e=I.get(t);return e||(e=new Set,I.set(t,e)),e},w=t=>typeof t=="object"&&t!==null,l=t=>{if(Array.isArray(t))return t.map(l);if(w(t)){const e={};return Object.keys(t).forEach(r=>{const s=t[r];typeof s>"u"||(e[r]=l(s))}),e}return t},S=t=>w(t)&&typeof t.toDate=="function",W=t=>{if(!t)return null;if(typeof t=="string")return t;if(S(t)){const e=t.toDate();return Number.isNaN(e.getTime())?null:e.toISOString().split("T")[0]}return null},D=t=>{const e=new Map;return t.forEach(r=>{const s=typeof r?.id=="string"?r.id.trim():"";s&&e.set(s,r)}),[...e.values()]},T=t=>u(y(),"users",t),x=async t=>{try{const e=t.uid;if(!e)return;const r=T(e),s={displayName:t.name??null,email:t.email??null,photoUrl:t.picture??null,providerId:t.provider??null,updatedAt:f()};try{await U(r,s);return}catch(a){if(a.code!=="not-found")throw a}await N(r,{...s,createdAt:f(),tier:"standard"},{merge:!0})}catch(e){throw console.warn("[firestore] upsertUserProfileFromAuth failed",e),e}},L=async t=>{try{const e=await R(T(t));if(!e.exists())return"standard";const s=e.data().tier;return s==="pro"||s==="premium"||s==="standard"?s:"standard"}catch(e){throw console.warn("[firestore] loadUserTierFromFirestore failed",e),e}},h=t=>E(y(),"users",t,"wardrobe"),M=async t=>{try{const e=await m(h(t)),r=[],s=g(t);return s.clear(),e.forEach(a=>{const o=a.data(),c=a.id;s.add(c);const d=typeof o.season=="string"?o.season:"Primavera",n=typeof o.status=="string"?o.status:"Ready",i=W(o.updatedAt)??new Date().toISOString().split("T")[0];r.push({id:c,name:typeof o.name=="string"?o.name:void 0,category:typeof o.category=="string"?o.category:"",color:typeof o.color=="string"?o.color:"",season:d,tags:Array.isArray(o.tags)?o.tags.filter(p=>typeof p=="string"):[],status:n,note:typeof o.note=="string"?o.note:"",location:typeof o.location=="string"?o.location:void 0,updatedAt:i,image:w(o.image)?l(o.image):void 0})}),r}catch(e){throw console.warn("[firestore] loadWardrobeFromFirestore failed",e),e}},j=async(t,e)=>{try{const r=y(),s=h(t),a=g(t),o=D(e),c=new Set(o.map(n=>n.id)),d=k(r);a.forEach(n=>{c.has(n)||d.delete(u(s,n))}),o.forEach(n=>{const i=n.id?.trim();if(!i)return;const p=!a.has(i),F=l({...n,createdAt:p?f():void 0,updatedAt:f()});F.id=i,d.set(u(s,i),F,{merge:!0})}),await d.commit(),a.clear(),c.forEach(n=>a.add(n))}catch(r){throw console.warn("[firestore] saveWardrobeToFirestore failed",r),r}},v=async(t,e)=>{try{const r=h(t);if(!(await m(b(r,A(1)))).empty)return{migrated:!1};const a=D(e);return a.length?(g(t).clear(),await j(t,a),{migrated:!(await m(b(r,A(1)))).empty}):{migrated:!1}}catch(r){throw console.warn("[firestore] migrateLocalToFirestoreIfNeeded failed",r),r}};export{T as getUserDocRef,L as loadUserTierFromFirestore,M as loadWardrobeFromFirestore,v as migrateLocalToFirestoreIfNeeded,j as saveWardrobeToFirestore,x as upsertUserProfileFromAuth};
